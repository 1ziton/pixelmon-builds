/**
 * @Based on pixelmon(cipchk@qq.com) v0.1.8
 * (c) 2019 developer(developer@1ziton.com)
 * 
 * Licensed under the MIT license:
 * https://opensource.org/licenses/MIT
 */
!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("@angular/core"),require("@angular/common"),require("rxjs"),require("@angular/forms"),require("@pixelmon/util"),require("ng-zorro-antd/upload"),require("ng-zorro-antd/spin"),require("ng-zorro-antd/modal"),require("ng-zorro-antd/button"),require("ng-zorro-antd/icon")):"function"==typeof define&&define.amd?define("@pixelmon/pikachu/upload",["exports","@angular/core","@angular/common","rxjs","@angular/forms","@pixelmon/util","ng-zorro-antd/upload","ng-zorro-antd/spin","ng-zorro-antd/modal","ng-zorro-antd/button","ng-zorro-antd/icon"],n):n(((e=e||self).pixelmon=e.pixelmon||{},e.pixelmon.pikachu=e.pixelmon.pikachu||{},e.pixelmon.pikachu.upload={}),e.ng.core,e.ng.common,e.rxjs,e.ng.forms,e.pixelmon.util,e["ng-zorro-antd/upload"],e["ng-zorro-antd/spin"],e["ng-zorro-antd/modal"],e["ng-zorro-antd/button"],e.icon)}(this,function(e,n,t,o,i,r,s,a,p,l,u){"use strict";var c=function(){return(c=Object.assign||function(e){for(var n,t=1,o=arguments.length;t<o;t++)for(var i in n=arguments[t])Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i]);return e}).apply(this,arguments)};var d=function(){};var h=function(){function e(e,n){var t=this;this._cdr=e,this._uploadSrv=n,this.accept="image/png,image/jpeg,image/gif,image/bmp",this.action="",this.directory=!1,this.disabled=!1,this.limit=9,this.size=0,this.fileType="image/png,image/jpeg,image/gif,image/bmp",this.listType="picture-card",this.multiple=!0,this.showButton=!0,this.placeholder="上传",this.maxLength=1/0,this.bucket="bucket",this.fastUpload=!0,this.filter=[{name:"maxLength",fn:function(e){return e.slice(0,t.maxLength-t.fileList.length)}}],this.showUploadList={showPreviewIcon:!0,showRemoveIcon:!0,hidePreviewIconInNonImage:!0},this.bosClient=null,this.isSupportWorker=!1,this.isLoading=!1,this.fileList=[],this.previewModal={visible:!1,image:""},this.preview=function(e){t.previewModal.image=e.url||e.thumbUrl,t.previewModal.visible=!0,t._cdr.detectChanges()},this.customRequest=function(e){var n=e.file;return t.getUploadKey(n).then(function(o){t.isSupportWorker&&t.fastUpload?t.bosClient.getObjectMetadata(t.bucket,o).then(function(i){n.url=t.bosClient.config.endpoint+"/v1/"+t.bucket+"/"+o,e.onSuccess("上传成功",n,i)}).catch(function(){return t.bosUpload(e,t.bucket,o,n)}):t.bosUpload(e,t.bucket,o,n)}),new o.Subscription},this.initBosClient()}return Object.defineProperty(e.prototype,"showPreviewIcon",{set:function(e){this.showUploadList=c({},this.showUploadList,{showPreviewIcon:e})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"showRemoveIcon",{set:function(e){this.showUploadList=c({},this.showUploadList,{showPreviewIcon:e})},enumerable:!0,configurable:!0}),e.prototype.ngOnInit=function(){"undefined"!=typeof Worker?this.isSupportWorker=!0:this.fastUpload&&console.error("浏览器不支持Worker，无法使用快传！")},e.prototype.writeValue=function(e){this.fileList=e||[],this.fileList.forEach(function(e){e.uid=e.uid||r.uuidv1()}),this._cdr.detectChanges()},e.prototype.registerOnChange=function(e){this.fileListChange=e},e.prototype.registerOnTouched=function(){},e.prototype.initBosClient=function(){var e=this;this._uploadSrv.getConfig()&&(this.isLoading=!0,this._uploadSrv.getConfig().subscribe(function(n){e.bosClient=new baidubce.sdk.BosClient({endpoint:n.endpoint,credentials:{ak:n.ak,sk:n.sk},sessionToken:n.sessionToken}),e.isLoading=!1,e._cdr.detectChanges()}))},e.prototype.getUploadKey=function(e){var n=this;return new Promise(function(t){if(n.isSupportWorker&&n.fastUpload){var o=new Worker(n._uploadSrv.workerUrl);o.onerror=function(e){console.error("Worker异常，已关闭！",e),o.terminate()},o.postMessage(e),o.onmessage=function(n){var i=""+n.data+e.lastModified+e.size+e.name;t(i),o.terminate()}}else{var i=""+(""+(new Date).getTime()+(1e4*Math.random()).toFixed(0))+e.lastModified+e.size+e.name;t(i)}})},e.prototype.bosUpload=function(e,n,t,o){var i=this;this.bosClient.putObjectFromBlob(n,t,o).then(function(r){o.url=i.bosClient.config.endpoint+"/v1/"+n+"/"+t,e.onSuccess("上传成功",o,r)}).catch(function(n){e.onError(n,o)})},e.prototype.onFileListChange=function(){this.fileListChange(this.fileList.map(function(e){return c({},e,{thumbUrl:""})})),this._cdr.detectChanges()},e.prototype.onChange=function(){this.fileList.forEach(function(e){e.url=e.url||e.originFileObj&&e.originFileObj.url}),this.onFileListChange()},e.decorators=[{type:n.Component,args:[{selector:"p-upload",exportAs:"pUpload",template:'<nz-upload\n  [nzAction]="action"\n  [nzAccept]="accept"\n  [nzListType]="listType"\n  [(nzFileList)]="fileList"\n  [nzShowButton]="showButton && fileList.length < maxLength"\n  [nzFileType]="fileType"\n  [nzShowUploadList]="showUploadList"\n  [nzDirectory]="directory"\n  [nzLimit]="limit"\n  [nzSize]="size"\n  [nzDisabled]="disabled || isLoading"\n  [nzMultiple]="multiple"\n  [nzPreview]="preview"\n  [nzRemove]="remove"\n  [nzFilter]="filter"\n  [nzBeforeUpload]="beforeUpload"\n  [nzCustomRequest]="customRequest"\n  (nzFileListChange)="onFileListChange()"\n  (nzChange)="onChange()"\n>\n  \x3c!-- 自定义content --\x3e\n  <ng-template [ngIf]="customContent" [ngIfElse]="defaultContent">\n    <ng-container [ngTemplateOutlet]="customContent"></ng-container>\n  </ng-template>\n\n  \x3c!-- 默认content --\x3e\n  <ng-template #defaultContent>\n    <ng-container [ngSwitch]="listType">\n      <ng-container *ngSwitchCase="\'picture-card\'">\n        <i nz-icon nzType="plus" class="upload-icon"></i>\n        <div class="upload-text">{{ placeholder }}</div>\n      </ng-container>\n      <ng-container *ngSwitchDefault>\n        <button nz-button>\n          <i nz-icon nzType="upload"></i>\n          <span>{{ placeholder }}</span>\n        </button>\n      </ng-container>\n    </ng-container>\n  </ng-template>\n</nz-upload>\n\n\x3c!-- 预览弹框 --\x3e\n<nz-modal [(nzVisible)]="previewModal.visible" [nzFooter]="null" (nzOnCancel)="previewModal.visible = false">\n  <img [src]="previewModal.image" width="100%" />\n</nz-modal>\n',providers:[{provide:i.NG_VALUE_ACCESSOR,useExisting:e,multi:!0}],changeDetection:n.ChangeDetectionStrategy.OnPush,styles:[".upload-icon{color:#999;font-size:32px}.upload-text{margin-top:8px;color:#666}"]}]}],e.ctorParameters=function(){return[{type:n.ChangeDetectorRef},{type:d}]},e.propDecorators={accept:[{type:n.Input}],action:[{type:n.Input}],directory:[{type:n.Input}],disabled:[{type:n.Input}],limit:[{type:n.Input}],size:[{type:n.Input}],fileType:[{type:n.Input}],listType:[{type:n.Input}],multiple:[{type:n.Input}],showButton:[{type:n.Input}],placeholder:[{type:n.Input}],customContent:[{type:n.Input}],maxLength:[{type:n.Input}],bucket:[{type:n.Input}],fastUpload:[{type:n.Input}],filter:[{type:n.Input}],showPreviewIcon:[{type:n.Input}],showRemoveIcon:[{type:n.Input}],beforeUpload:[{type:n.Input}],remove:[{type:n.Input}],preview:[{type:n.Input}],customRequest:[{type:n.Input}]},e}();var g=function(){function e(){}return e.decorators=[{type:n.NgModule,args:[{declarations:[h],imports:[t.CommonModule,s.NzUploadModule,p.NzModalModule,a.NzSpinModule,l.NzButtonModule,u.NzIconModule],exports:[h]}]}],e}();e.UploadModule=g,e.UploadServiceToken=d,e.ɵa=h,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=pUpload.umd.min.js.map